<html>
  <head>
    <title>Attendance Scanner</title>
    <style>
      body {
        background: #f7f9fa;
        font-family: "Segoe UI", Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }

      .scanner-container {
        background: #fff;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(60, 60, 60, 0.13);
        padding: 2rem 2.5rem 2.5rem 2.5rem;
        margin-top: 3rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }

      .video-wrapper {
        position: relative;
        display: inline-block;
      }

      #video {
        width: 420px;
        height: 320px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.09);
        background: #222;
        object-fit: cover;
        z-index: 1;
        position: relative;
      }

      .overlay {
        pointer-events: none;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        border-radius: 16px;
        box-sizing: border-box;
        z-index: 2;
      }

      .overlay.green {
        border: 8px solid #2ecc40;
        box-shadow: 0 0 0 6px #2ecc4033;
      }

      .overlay.yellow {
        border: 8px solid #ffdc00;
        box-shadow: 0 0 0 6px #ffdc0033;
      }

      .overlay.red {
        border: 8px solid #ff4d4f;
        box-shadow: 0 0 0 6px rgba(255, 77, 79, 0.3);
        background: rgba(255, 77, 79, 0.1);
      }

      .overlay.none {
        border: none;
        box-shadow: none;
      }

      .status {
        margin-top: 1.2rem;
        font-size: 1.15rem;
        font-weight: 600;
        padding: 0.7rem 1.5rem;
        border-radius: 12px;
        color: #333;
        background: #f1f1f1;
        min-width: 220px;
        text-align: center;
        transition:
          background 0.3s,
          color 0.3s;
      }

      .status.green {
        background: #eafbe7;
        color: #207a2c;
      }

      .status.yellow {
        background: #fffbe6;
        color: #b59b00;
      }

      .status.red {
        background: #fff0f0;
        color: #b20000;
      }

      .status.none {
        background: #f1f1f1;
        color: #333;
      }

      .status.closed {
        background: #e4e7ef;
        color: #7f8fa6;
      }

      @media (max-width: 600px) {
        #video {
          width: 95vw;
          height: 52vw;
        }

        .scanner-container {
          padding: 1rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="scanner-container">
      <h2 style="margin-bottom: 1.2rem; color: #222">Attendance Scanner</h2>
      <div class="video-wrapper">
        <video id="video" autoplay playsinline></video>
        <div id="videoOverlay" class="overlay none"></div>
      </div>
      <div id="status" class="status none">Waiting...</div>
    </div>
    <script>
      const status = document.getElementById("status");
      const video = document.getElementById("video");
      const overlay = document.getElementById("videoOverlay");
      let startTime = null;
      let endTime = null;
      let scanning = false;
      let endTimer = null; // to store the timeout for closing attendance

      // Access camera
      navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
        video.srcObject = stream;
      });
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");

      // Close attendance day and mark absentees
      async function closeAttendanceDay() {
        console.log("Closing attendance day and marking absentees...");
        try {
          const res = await fetch("/attendance/close-day", { method: "POST" });
          const data = await res.json();
          console.log("Absentee job result:", data);
        } catch (err) {
          console.error("Failed to close attendance:", err);
        }
      }

      // UI helpers
      function setOverlay(color) {
        overlay.className = "overlay";
        overlay.classList.add(color && color !== "none" ? color : "none");
      }
      function setStatus(msg, color) {
        status.textContent = msg;
        status.className = `status ${color}`;
      }

      // Check if current time is within attendance window
      function isWithinAttendanceWindow() {
        const now = new Date();
        return now >= startTime && now <= endTime;
      }

      // Loop to continuously scan faces
      function scanLoop() {
        if (!scanning || !isWithinAttendanceWindow()) {
          setOverlay("none");
          setStatus("Attendance Closed!", "closed");
          scanning = false;
          return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        canvas.toBlob((blob) => {
          const form = new FormData();
          form.append("image", blob, "capture.jpg");

          fetch("/scan-face", { method: "POST", body: form })
            .then((res) => res.json())
            .then((data) => {
              const result = data.result?.message || data.message;

              if (
                result === "Already Present" ||
                result === "Attendance Already Recorded"
              ) {
                setOverlay("yellow");
                setStatus("Attendance Already Registered!", "yellow");
              } else if (
                result === "New Attendance" ||
                (result && result.toLowerCase().includes("marked"))
              ) {
                setOverlay("green");
                setStatus("Attendance Marked Successfully!", "green");
              } else if (result === "Attendance is not open at this time") {
                setOverlay("none");
                setStatus("Attendance Closed!", "closed");
                scanning = false;
              } else if (result === "No Face Detected") {
                setOverlay("none");
                setStatus("No Face Detected!", "none");
              } else if (
                result === "Unknown Face" ||
                (result && result.toLowerCase().includes("not recognized"))
              ) {
                setOverlay("red");
                setStatus("Face Not Recognized", "red");
              } else {
                setOverlay("none");
                setStatus(result, "none");
              }

              if (scanning) setTimeout(scanLoop, 1000);
            });
        }, "image/jpeg");
      }

      // Initialize scanner and attendance timings
      async function initScanner() {
        try {
          const res = await fetch("/timings");
          const data = await res.json();
          const [startH, startM] = data.start.split(":").map(Number);
          const [endH, endM] = data.end.split(":").map(Number);

          const now = new Date();
          startTime = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate(),
            startH,
            startM,
            0,
            0,
          );
          endTime = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate(),
            endH,
            endM,
            0,
            0,
          );

          scanning = isWithinAttendanceWindow();

          if (scanning) {
            setStatus("Attendance Open! Scanning...", "none");
            scanLoop();

            // Schedule closeAttendanceDay at exact endTime
            const msUntilEnd = endTime - new Date();
            if (msUntilEnd > 0) {
              if (endTimer) clearTimeout(endTimer);
              endTimer = setTimeout(() => {
                closeAttendanceDay();
                setOverlay("none");
                setStatus("Attendance Closed!", "closed");
                scanning = false;
              }, msUntilEnd);
            }
          } else {
            setStatus("Attendance Closed!", "closed");

            // If page loads after attendance window, immediately close attendance
            closeAttendanceDay();
          }

          // Refresh timings every minute in case start/end changes
          setInterval(async () => {
            try {
              const res = await fetch("/timings");
              const data = await res.json();
              const [startH, startM] = data.start.split(":").map(Number);
              const [endH, endM] = data.end.split(":").map(Number);

              const now = new Date();
              startTime = new Date(
                now.getFullYear(),
                now.getMonth(),
                now.getDate(),
                startH,
                startM,
                0,
                0,
              );
              endTime = new Date(
                now.getFullYear(),
                now.getMonth(),
                now.getDate(),
                endH,
                endM,
                0,
                0,
              );

              const wasScanning = scanning;
              scanning = isWithinAttendanceWindow();

              if (!scanning && wasScanning) {
                setOverlay("none");
                setStatus("Attendance Closed!", "closed");

                // Trigger absent marking once
                closeAttendanceDay();
                if (endTimer) clearTimeout(endTimer);
              } else if (scanning && !wasScanning) {
                setStatus("Attendance Reopened!", "none");
                scanLoop();

                // Schedule again for end time
                const msUntilEnd = endTime - new Date();
                if (msUntilEnd > 0) {
                  if (endTimer) clearTimeout(endTimer);
                  endTimer = setTimeout(() => {
                    closeAttendanceDay();
                    setOverlay("none");
                    setStatus("Attendance Closed!", "closed");
                    scanning = false;
                  }, msUntilEnd);
                }
              }
            } catch (err) {
              setStatus("Failed to refresh timings!", "red");
              setOverlay("red");
            }
          }, 60000);
        } catch (err) {
          setStatus("Failed to fetch timings!", "red");
          setOverlay("red");
          console.error("Timings fetch error:", err);
        }
      }

      setTimeout(initScanner, 1000);
    </script>
  </body>
</html>
